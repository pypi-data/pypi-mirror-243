use std::fs::File;
use std::io::Write;
use std::path::{Path, PathBuf};
use std::process::Command;

fn main() {
    // Proto bindings generation
    let mut config = prost_build::Config::default();
    assert!(Command::new("env")
        .args(&["mkdir", "-p", "src/proto"])
        .spawn()
        .unwrap()
        .wait()
        .unwrap()
        .success());
    config.out_dir("src/proto");
    config.extern_path(".attestation", "::delta_attestation_api");
    config.extern_path(".data_room", "::delta_data_room_api");
    config.protoc_arg("--experimental_allow_proto3_optional");
    config
        .compile_protos(
            &["src/build-deps/proto/metering.proto"],
            &[
                PathBuf::from("src/build-deps/proto"),
                PathBuf::from("../delta-attestation-api/src/build-deps/proto"),
                PathBuf::from("../delta-data-room-api/src/build-deps/proto"),
            ],
        )
        .unwrap();

    // touch .autogenerated-files
    assert!(std::process::Command::new("env")
        .args(&["touch", "src/proto/.autogenerated-files"])
        .spawn()
        .unwrap()
        .wait()
        .unwrap()
        .success());

    let mod_content = b"\
        mod metering;\n\
        \n\
        pub use metering::*;\n\
    ";
    let dest_path = Path::new(".").join("src/proto/mod.rs");
    let mut f = File::create(&dest_path).expect("Failed to create proto/mod.rs");
    f.write_all(mod_content)
        .expect("Failed to write proto/mod.rs");

    println!("cargo:rerun-if-changed=src/build-deps/proto/metering.proto");
}
