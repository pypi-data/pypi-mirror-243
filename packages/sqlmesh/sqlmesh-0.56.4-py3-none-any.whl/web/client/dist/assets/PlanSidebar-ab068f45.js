import{r as j,D as He,a9 as Ke,I as We,y as Qe,x as oe,F as Xe,R as Y,aa as Ye,ab as Ze,ac as Je,X as Ie,ad as qe,Q as es,M as Te,j as e,a4 as be,ae as Oe,a as J,a2 as y,af as p,e as $,o as R,a7 as me,a5 as W,a1 as ae,ag as De,d as g,c as D,ah as Se,ai as q,aj as ee,ak as N,k as I,t as le,$ as X,al as _e,n as Z,am as Re,L as Ne,S as ze,u as Ue,a0 as ss,an as as,ao as ns,E as Ee}from"./index-10cf6bcc.js";import{B as K}from"./Banner-73804d47.js";import{R as ls,p as ts}from"./ReportErrors-d29e52ee.js";import{v as M,M as je,P as ge}from"./disclosure-e6c452a2.js";import{M as is,H as rs,u as G,a as ke,b as _,E as P,P as A,C as ve,c as cs}from"./PlanChangePreview-6e7c1aa9.js";import{I as H}from"./SearchList-ef742eab.js";import{s as os}from"./popover-e2907f5e.js";import{T as ds,p as ms}from"./context-eed4063d.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./ModelLineage-1440e33b.js";import"./PlusIcon-932d8943.js";function us({title:s,titleId:n,...a},l){return j.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:l,"aria-labelledby":n},a),s?j.createElement("title",{id:n},s):null,j.createElement("path",{fillRule:"evenodd",d:"M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z",clipRule:"evenodd"}))}const xs=j.forwardRef(us),ps=xs;let Pe=j.createContext(null);Pe.displayName="GroupContext";let hs=j.Fragment;function fs(s){var n;let[a,l]=j.useState(null),[d,m]=rs(),[c,t]=qe(),u=j.useMemo(()=>({switch:a,setSwitch:l,labelledby:d,describedby:c}),[a,l,d,c]),o={},x=s;return Y.createElement(t,{name:"Switch.Description"},Y.createElement(m,{name:"Switch.Label",props:{htmlFor:(n=u.switch)==null?void 0:n.id,onClick(i){a&&(i.currentTarget.tagName==="LABEL"&&i.preventDefault(),a.click(),a.focus({preventScroll:!0}))}}},Y.createElement(Pe.Provider,{value:u},Ie({ourProps:o,theirProps:x,defaultTag:hs,name:"Switch.Group"}))))}let js="button";function gs(s,n){let a=We(),{id:l=`headlessui-switch-${a}`,checked:d,defaultChecked:m=!1,onChange:c,name:t,value:u,form:o,...x}=s,i=j.useContext(Pe),r=j.useRef(null),w=Qe(r,n,i===null?null:i.setSwitch),[C,v]=ds(d,c,m),f=oe(()=>v==null?void 0:v(!C)),F=oe(k=>{if(es(k.currentTarget))return k.preventDefault();k.preventDefault(),f()}),S=oe(k=>{k.key===Te.Space?(k.preventDefault(),f()):k.key===Te.Enter&&ms(k.currentTarget)}),T=oe(k=>k.preventDefault()),O=j.useMemo(()=>({checked:C}),[C]),z={id:l,ref:w,role:"switch",type:os(s,r),tabIndex:0,"aria-checked":C,"aria-labelledby":i==null?void 0:i.labelledby,"aria-describedby":i==null?void 0:i.describedby,onClick:F,onKeyUp:S,onKeyPress:T},U=Xe();return j.useEffect(()=>{var k;let E=(k=r.current)==null?void 0:k.closest("form");E&&m!==void 0&&U.addEventListener(E,"reset",()=>{v(m)})},[r,v]),Y.createElement(Y.Fragment,null,t!=null&&C&&Y.createElement(Ye,{features:Ze.Hidden,...Je({as:"input",type:"checkbox",hidden:!0,readOnly:!0,form:o,checked:C,name:t,value:u})}),Ie({ourProps:z,theirProps:x,slot:O,defaultTag:js,name:"Switch"}))}let vs=He(gs),bs=fs,ye=Object.assign(vs,{Group:bs,Label:is,Description:Ke});function ys({show:s,children:n,afterLeave:a,onClose:l=()=>{}}){return e.jsx(be,{appear:!0,show:s,as:j.Fragment,afterLeave:a,children:e.jsxs(Oe,{as:"div",className:"relative z-[100] w-full h-full ",onClose:l,tabIndex:1,children:[e.jsx(be.Child,{as:j.Fragment,enter:"ease-out duration-300",enterFrom:"bg-overlay opacity-0",enterTo:"bg-overlay opacity-80",leave:"ease-in duration-200",leaveFrom:"bg-overlay opacity-80",leaveTo:"bg-overlay opacity-0",children:e.jsx("div",{className:"fixed inset-0"})}),e.jsx("div",{className:"w-full h-full fixed inset-0",children:e.jsx(be.Child,{as:j.Fragment,enter:"ease-out duration-300",enterFrom:"translate-x-[100%]",enterTo:"translate-x-0",leave:"ease-in duration-200",leaveFrom:"translate-x-0",leaveTo:"translate-x-[100%]",children:n})})]})})}function ws(){const s=J(a=>a.environment),n=s.isInitial&&s.isDefault;return e.jsxs("div",{className:"flex flex-col pb-2 w-full",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h4",{className:"flex items-center text-xl px-6 font-bold whitespace-nowrap",children:[e.jsx("span",{children:"Target Environment is"}),e.jsx("span",{className:"block ml-2 px-2 py-1 font-sm rounded-md bg-primary-10 text-primary-500",children:s.name})]}),e.jsx("div",{className:"px-6",children:e.jsx(ls,{})})]}),e.jsx("div",{className:"w-full h-full overflow-auto scrollbar scrollbar--vertical px-4 py-2",children:n&&e.jsx(K,{variant:y.Warning,children:e.jsx(M,{defaultOpen:!1,children:({open:a})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(K.Headline,{className:"w-full mr-2 text-sm !mb-0",children:"Initializing Prod Environment"}),e.jsx(M.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:a?e.jsx(je,{className:"h-6 w-6 text-warning-500"}):e.jsx(ge,{className:"h-6 w-6 text-warning-500"})})]}),e.jsx(M.Panel,{className:"px-4 pb-2 text-sm mt-2",children:e.jsx(K.Description,{children:"Prod will be completely backfilled in order to ensure there are no data gaps. After this is applied, it is recommended to validate further changes in a dev environment before deploying to production."})})]})})})})]})}function Ns(s=0){return j.useCallback(n=>{setTimeout(()=>{n==null||n.focus()},s)},[s])}function ne(s,n=[],a="Start"){if(!n.includes(s))return a;let l;switch(s){case p.Done:l="Done";break;case p.Running:l="Running...";break;case p.Applying:l="Applying...";break;case p.Cancelling:l="Cancelling...";break;case p.Run:l="Run";break;case p.ApplyVirtual:l="Apply Virtual";break;case p.ApplyBackfill:l="Apply Backfill";break;default:l=a;break}return l}function ks(s){return Object.values(s??{}).some($)}function Ps({disabled:s,run:n,apply:a,cancel:l,close:d,reset:m,planAction:c}){const{start:t,end:u,skip_tests:o,auto_apply:x,skip_backfill:i,no_gaps:r,no_auto_categorization:w,forward_only:C,restate_models:v,include_unmodified:f}=G(),F=J(B=>B.environment),S=Ns(),T=c===p.Run,O=c===p.Done,z=c===p.Cancelling,U=c===p.ApplyVirtual,k=c===p.ApplyBackfill,E=c===p.Applying,V=c===p.Running,b=V||E||z;function ce(B){B.stopPropagation(),d()}function se(B){B.stopPropagation(),m()}function $e(B){B.stopPropagation(),l()}function Ge(B){B.stopPropagation(),a()}function Le(B){B.stopPropagation(),n()}return e.jsxs("div",{children:[(T||V||U||k||E)&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full flex px-4 py-2",children:e.jsxs("p",{className:"ml-2 text-xs",children:[e.jsx("span",{children:"Plan for"}),e.jsx("b",{className:"text-primary-500 font-bold mx-1",children:F.name}),e.jsx("span",{className:"inline-block mr-1",children:"environment"}),e.jsxs("span",{className:"inline-block mr-1",children:["from"," ",e.jsx("b",{children:R(me(t))?t:"the begining of history"})]}),e.jsxs("span",{className:"inline-block mr-1",children:["till"," ",e.jsx("b",{children:R(me(t))?u:"today"})]}),r&&e.jsxs("span",{className:"inline-block mr-1",children:["with ",e.jsx("b",{children:"No Gaps"})]}),i&&e.jsxs("span",{className:"inline-block mr-1",children:["without ",e.jsx("b",{children:"Backfills"})]}),C&&e.jsxs("span",{className:"inline-block mr-1",children:["consider as a ",e.jsx("b",{children:"Breaking Change"})]}),w&&e.jsxs("span",{className:"inline-block mr-1",children:["also set ",e.jsx("b",{children:"Change Category"})," manually"]}),R(me(v))&&e.jsxs("span",{className:"inline-block mr-1",children:["and restate folowing models ",e.jsx("b",{children:v})]}),f&&e.jsx("span",{className:"inline-block mr-1",children:"with views for all models"})]})}),e.jsx(W,{})]}),e.jsxs("div",{className:"flex justify-between px-4 py-2",children:[e.jsxs("div",{className:"flex w-full items-center",children:[(T||V)&&e.jsxs(ae,{disabled:V||s,onClick:Le,ref:S,variant:y.Primary,autoFocus:!0,children:[e.jsx("span",{children:ne(c,[p.Running,p.Run])}),o&&e.jsx("span",{className:"inline-block ml-1",children:"And Skip Test"}),x&&e.jsx("span",{className:"inline-block ml-1",children:"And Auto Apply"})]}),(k||U||E)&&e.jsx(ae,{onClick:Ge,disabled:E||s,ref:S,variant:y.Primary,children:ne(c,[p.Applying],k?"Apply And Backfill":"Apply Virtual Update")}),b&&e.jsx(ae,{onClick:$e,variant:y.Danger,className:"justify-self-end",disabled:z||s,children:ne(c,[p.Cancelling],"Cancel")})]}),e.jsxs("div",{className:"flex items-center",children:[[b,T,s].every(R)&&e.jsx(ae,{onClick:se,variant:y.Neutral,disabled:De([p.Running,p.Applying,p.Cancelling],c)||s,children:ne(c,[],"Start Over")}),e.jsx(ae,{onClick:ce,variant:O?y.Primary:y.Neutral,disabled:De([p.Running,p.Cancelling],c)||s,ref:O||E?S:void 0,children:ne(c,[p.Done],"Close")})]})]})]})}function Cs({label:s,enabled:n,setEnabled:a,a11yTitle:l,size:d=D.md,disabled:m=!1,className:c}){return e.jsxs(ye.Group,{as:"div",className:"flex items-center m-1",children:[e.jsxs(ye,{checked:m?!1:n,onChange:a,className:g("flex relative border-secondary-30 rounded-full m-0","shrink-0 focus:outline-none ring-secondary-300 ring-opacity-60 ring-offset ring-offset-secondary-100 focus:border-secondary-500 focus-visible:ring-opacity-75","transition duration-200 ease-in-out",n?"bg-secondary-500":"bg-secondary-20",c,m?"opacity-50 cursor-not-allowed":"cursor-pointer",d===D.sm&&"h-[14px] w-6 focus:ring-1 border",d===D.md&&"h-5 w-10 focus:ring-2 border-2",d===D.lg&&"h-7 w-14 focus:ring-4 border-2"),disabled:m,children:[e.jsx("span",{className:"sr-only",children:l}),e.jsx("span",{"aria-hidden":"true",className:g("pointer-events-none inline-block transform rounded-full shadow-md transition duration-200 ease-in-out","bg-light",d===D.sm&&"h-3 w-3",d===D.md&&"h-4 w-4",d===D.lg&&"h-6 w-6",n&&d===D.sm&&"translate-x-[10px]",n&&d===D.md&&"translate-x-5",n&&d===D.lg&&"translate-x-7")})]}),s!=null&&e.jsx(ye.Label,{className:g("text-xs font-light ml-1 text-neutral-600 dark:text-neutral-400"),children:s})]})}function Q({label:s,info:n,enabled:a,disabled:l=!1,setEnabled:d,className:m}){return e.jsxs("div",{className:g("flex justify-between",m),children:[e.jsxs("label",{className:"block mb-1 px-3 text-sm font-bold",children:[s,e.jsx("small",{className:"block text-xs text-neutral-500",children:n})]}),e.jsx(Cs,{disabled:l,enabled:a,setEnabled:d,size:D.lg})]})}function Ts({disabled:s=!1}){const n=ke(),{start:a,end:l,isInitialPlanRun:d}=G();return e.jsxs("div",{className:"flex w-full flex-wrap md:flex-nowrap",children:[e.jsx(H,{className:"w-full md:w-[50%]",label:"Start Date (UTC)",info:"The start datetime of the interval",disabled:s||d,children:({disabled:m,className:c})=>e.jsx(H.Textfield,{className:g(c,"w-full"),disabled:m,placeholder:"2023-12-13",value:a,onInput:t=>{t.stopPropagation(),n({type:_.DateStart,start:t.target.value})}})}),e.jsx(H,{className:"w-full md:w-[50%]",label:"End Date (UTC)",info:"The end datetime of the interval",disabled:s||d,children:({disabled:m,className:c})=>e.jsx(H.Textfield,{className:g(c,"w-full"),disabled:m,placeholder:"2022-12-13",value:l,onInput:t=>{t.stopPropagation(),n({type:_.DateEnd,end:t.target.value})}})})]})}function Ds({className:s}){const n=ke(),{skip_tests:a,no_gaps:l,skip_backfill:d,forward_only:m,auto_apply:c,no_auto_categorization:t,restate_models:u,isInitialPlanRun:o,create_from:x,include_unmodified:i}=G(),r=J(v=>v.environment),w=J(v=>v.environments),C=Se.getOnlySynchronized(Array.from(w));return e.jsxs("form",{className:"w-full h-full",children:[e.jsxs("fieldset",{className:g("mb-10 mt-6"),children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1 px-4",children:"Set Dates"}),e.jsx("div",{className:"mt-3",children:e.jsx(Ts,{})})]}),e.jsx("fieldset",{className:g("mb-4 mt-6"),children:e.jsx(M,{children:({open:v})=>e.jsxs(e.Fragment,{children:[e.jsxs(M.Button,{className:"flex items-center w-full justify-between rounded-lg text-left text-sm px-4 pt-3 pb-2 bg-neutral-10 hover:bg-theme-darker dark:hover:bg-theme-lighter",children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1",children:"Additional Options"}),v?e.jsx(je,{className:"h-6 w-6 text-primary-500"}):e.jsx(ge,{className:"h-6 w-6 text-primary-500"})]}),e.jsxs(M.Panel,{className:"px-4 pb-2 text-sm text-neutral-500",children:[e.jsx("div",{className:"mt-3",children:e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap",children:[R(r.isDefault)&&e.jsx(H,{className:"w-full",label:"Create From Environment",info:"The environment to base the plan on rather than local files",disabled:C.length<2,children:({className:f,disabled:F})=>e.jsx(H.Selector,{className:g(f,"w-full"),list:Se.getOnlySynchronized(Array.from(w)).map(S=>({value:S.name,text:S.name})),onChange:S=>{n({type:_.PlanOptions,create_from:S})},value:x,disabled:F})}),e.jsx(H,{className:"w-full",label:"Restate Models",info:`Restate data for specified models and models
                    downstream from the one specified. For production
                    environment, all related model versions will have
                    their intervals wiped, but only the current
                    versions will be backfilled. For development
                    environment, only the current model versions will
                    be affected`,children:({className:f})=>e.jsx(H.Textfield,{className:g(f,"w-full"),placeholder:"project.model1, project.model2",disabled:o,value:u??"",onInput:F=>{F.stopPropagation(),n({type:_.PlanOptions,restate_models:F.target.value})}})})]})}),e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap w-full mt-3",children:[e.jsxs("div",{className:"w-full md:mr-2",children:[e.jsx("div",{className:"block my-2",children:e.jsx(Q,{label:"Skip Tests",info:`Skip tests prior to generating the plan if they
              are defined`,enabled:!!a,setEnabled:f=>{n({type:_.PlanOptions,skip_tests:f})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(Q,{label:"No Gaps",info:`Ensure that new snapshots have no data gaps when
              comparing to existing snapshots for matching
              models in the target environment`,enabled:!!l,disabled:o,setEnabled:f=>{n({type:_.PlanOptions,no_gaps:f})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(Q,{label:"Skip Backfill",info:"Skip the backfill step",enabled:!!d,disabled:o,setEnabled:f=>{n({type:_.PlanOptions,skip_backfill:f})}})})]}),e.jsxs("div",{className:"w-full md:ml-2",children:[e.jsxs("div",{className:"block my-2",children:[e.jsx(Q,{label:"Include Unmodified",info:"Indicates whether to create views for all models in the target development environment or only for modified ones",enabled:!!i,disabled:o,setEnabled:f=>{n({type:_.PlanOptions,include_unmodified:f})}}),e.jsx(Q,{label:"Forward Only",info:"Create a plan for forward-only changes",enabled:!!m,disabled:o,setEnabled:f=>{n({type:_.PlanOptions,forward_only:f})}})]}),e.jsx("div",{className:"block my-2",children:e.jsx(Q,{label:"Auto Apply",info:"Automatically apply the plan after it is generated",enabled:!!c,setEnabled:f=>{n({type:_.PlanOptions,auto_apply:f})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(Q,{label:"No Auto Categorization",info:"Set category manually",enabled:!!t,disabled:o,setEnabled:f=>{n({type:_.PlanOptions,no_auto_categorization:f})}})})]})]})]})]})})})]})}function Ss({environment:s,isInitialPlanRun:n}){const{start:a,end:l,skip_tests:d,no_gaps:m,skip_backfill:c,forward_only:t,no_auto_categorization:u,restate_models:o,create_from:x,include_unmodified:i}=G(),r=j.useMemo(()=>{if(!s.isDefault)return{start:a,end:n&&me(o)?void 0:l}},[s,a,l,n,o]);return{planOptions:j.useMemo(()=>s.isDefault||s.isInitial?{skip_tests:d,include_unmodified:!0}:{no_gaps:m,skip_backfill:c,forward_only:t,create_from:x,no_auto_categorization:u,skip_tests:d,restate_models:o,include_unmodified:i},[s,m,c,t,i,x,u,d,o]),planDates:r}}function _s({isInitialPlanRun:s}){const{start:n,end:a,skip_tests:l,no_gaps:d,skip_backfill:m,forward_only:c,include_unmodified:t,no_auto_categorization:u,restate_models:o,create_from:x,change_categorization:i}=G(),r=j.useMemo(()=>{if(!s)return{start:n,end:a}},[n,a,s]),w=j.useMemo(()=>Array.from(i.values()).reduce((C,{category:v,change:f})=>(C[f.model_name]=v.value,C),{}),[i]);return{planDates:r,planOptions:{no_gaps:d,skip_backfill:m,forward_only:c,include_unmodified:t,create_from:x,no_auto_categorization:u,skip_tests:l,restate_models:o},categories:w}}function te({progress:s=0,delay:n=0,duration:a=0,className:l}){return e.jsx("div",{className:g("w-full h-1 bg-neutral-30 overflow-hidden flex items-center rounded-lg my-1",l),children:e.jsx("div",{className:"transition-[width] h-full bg-success-500 rounded-lg",style:{width:`${s}%`,transitionDelay:`${n}ms`,transitionDuration:`${a}ms`}})})}const h=function({children:n,setRefTasksOverview:a,tasks:l}){const{models:d,taskCompleted:m,taskTotal:c,batchesTotal:t,batchesCompleted:u}=j.useMemo(()=>{const o=Object.entries(l),x=o.length;let i=0,r=0,w=0;return o.forEach(([C,{completed:v,total:f}])=>{i=v===f?i+1:i,r+=f,w+=v}),{models:o,taskCompleted:i,taskTotal:x,batchesTotal:r,batchesCompleted:w}},[l]);return e.jsx("div",{className:"text-prose",ref:a,children:n({models:d,completed:m,total:c,totalBatches:t,completedBatches:u})})};function Rs({className:s,headline:n,environment:a,completed:l,total:d,updatedAt:m,updateType:c,completedBatches:t,totalBatches:u}){return e.jsx(Ce,{className:s,children:e.jsxs(ue,{children:[e.jsxs(xe,{children:[e.jsx(pe,{children:e.jsx(Ve,{headline:n,environment:a})}),e.jsxs(he,{children:[e.jsx(ie,{completed:l,total:d,unit:"task"}),e.jsx(re,{}),e.jsx(ie,{completed:t,total:u,unit:"batches"}),e.jsx(re,{}),e.jsx(fe,{completed:t,total:u})]})]}),e.jsx(te,{progress:q(t,u)}),m!=null&&e.jsx(Fs,{updatedAt:m,updateType:c})]})})}function Es({models:s,className:n,changes:a,showBatches:l=!0,showProgress:d=!0,showVirtualUpdate:m=!1,queue:c}){const{changesAdded:t,changesRemoved:u,changesModifiedDirect:o,changesModifiedIndirect:x}=j.useMemo(()=>{const i=a==null?void 0:a.modified;return{changesAdded:(a==null?void 0:a.added)??[],changesRemoved:(a==null?void 0:a.removed)??[],changesModifiedMetadata:(i==null?void 0:i.metadata)??[],changesModifiedIndirect:((i==null?void 0:i.indirect)??[]).map(({model_name:r})=>r),changesModifiedDirect:((i==null?void 0:i.direct)??[]).map(({model_name:r})=>r)}},[a]);return e.jsxs(e.Fragment,{children:[$(c)&&e.jsxs("div",{className:"p-4 mt-6 shadow-lg bg-neutral-5 rounded-lg",children:[e.jsx(ee,{text:"Currently in proccess"}),e.jsx(we,{models:s.filter(([i])=>c==null?void 0:c.includes(i)),children:([i,r])=>e.jsxs(ue,{children:[e.jsxs(xe,{children:[e.jsxs(pe,{children:[N(r.interval)&&e.jsx(Fe,{start:r.interval[0],end:r.interval[1]}),e.jsx(Me,{modelName:i,changeType:Be({modelName:i,changesAdded:t,changesRemoved:u,changesModifiedDirect:o,changesModifiedIndirect:x})})]}),e.jsxs(he,{children:[l&&e.jsx(ie,{completed:r.completed,total:r.total,unit:"batch"}),e.jsx(re,{}),d&&e.jsx(e.Fragment,{children:I(r.end)||I(r.start)?e.jsx(fe,{total:r.total,completed:r.completed}):e.jsx(Ae,{start:r.start,end:r.end})}),m&&e.jsx("span",{className:"inline-block whitespace-nowrap font-bold ml-2",children:"Updated"})]})]}),d?e.jsx(te,{progress:q(r.completed,r.total)}):e.jsx(W,{className:"my-1 border-neutral-200 opacity-50"})]})})]}),e.jsx(Ce,{className:n,children:e.jsx(we,{models:s,children:([i,r])=>e.jsxs(ue,{children:[e.jsxs(xe,{children:[e.jsxs(pe,{children:[N(r.interval)&&e.jsx(Fe,{start:r.interval[0],end:r.interval[1]}),e.jsx(Me,{modelName:i,changeType:Be({modelName:i,changesAdded:t,changesRemoved:u,changesModifiedDirect:o,changesModifiedIndirect:x})})]}),e.jsxs(he,{children:[l&&e.jsx(ie,{completed:r.completed,total:r.total,unit:"batch"}),e.jsx(re,{}),d&&e.jsx(e.Fragment,{children:I(r.end)||I(r.start)?e.jsx(fe,{total:r.total,completed:r.completed}):e.jsx(Ae,{start:r.start,end:r.end})}),m&&e.jsx("span",{className:"inline-block whitespace-nowrap font-bold ml-2",children:"Updated"})]})]}),d?e.jsx(te,{progress:q(r.completed,r.total)}):e.jsx(W,{className:"my-1 border-neutral-200 opacity-50"})]})})})]})}function Ce({className:s,children:n}){return e.jsx("div",{className:g("my-3 max-h-[50vh] overflow-auto hover:scrollbar scrollbar--vertical scrollbar--horizontal",s),children:n})}function ue({className:s,children:n}){return e.jsx("div",{className:g("px-2",s),children:n})}function we({className:s,models:n,children:a}){return e.jsx("ul",{className:g("rounded-lg py-4 overflow-auto text-prose hover:scrollbar scrollbar--vertical scrollbar--horizontal",s),children:n.map(([l,d])=>e.jsx("li",{className:"mb-2",children:a([l,d])},l))})}function xe({className:s,children:n}){return e.jsx("div",{className:g("flex sm:justify-between sm:items-baseline text-xs",s),children:n})}function Ve({className:s,headline:n,environment:a}){return e.jsxs("span",{className:g("flex items-center",s),children:[e.jsx("span",{className:"block whitespace-nowrap text-sm font-medium",children:n}),N(a)&&e.jsx("small",{className:"inline-block ml-1 px-2 py-[0.125rem] text-xs font-bold bg-neutral-10 rounded-md",children:a})]})}function pe({className:s,children:n}){return e.jsx("div",{className:g("flex mr-6 w-full sm:w-auto overflow-hidden",s),children:n})}function he({className:s,children:n}){return e.jsx("div",{className:g("flex items-center",s),children:n})}function Fe({className:s,start:n,end:a}){return e.jsxs("span",{className:g("inline-block mr-2 whitespace-nowrap font-mono",s),children:[n," – ",a]})}function ie({className:s,total:n,completed:a,unit:l}){return e.jsxs("span",{className:g("inline-block whitespace-nowrap",s),children:[a," of ",n," ",ts(l,n)]})}function re({className:s}){return e.jsx("span",{className:g("inline-block mx-2",s),children:"|"})}function fe({className:s,total:n,completed:a}){return e.jsxs("span",{className:g("inline-block whitespace-nowrap font-bold",s),children:[Math.ceil(q(a,n)),"%"]})}function Ae({className:s,start:n,end:a}){return e.jsx("span",{className:g("inline-block whitespace-nowrap font-bold",s),children:`${Math.floor((a-n)/6e4)}:${String(Math.ceil((a-n)/1e3%60)).padStart(2,"0")}`})}function Fs({updateType:s,updatedAt:n}){return e.jsxs("div",{className:"flex justify-between mt-1",children:[e.jsxs("small",{className:"text-xs",children:[e.jsx("b",{children:"Update Type:"}),e.jsx("span",{className:"inline-block ml-1",children:s})]}),e.jsxs("small",{className:"text-xs",children:[e.jsx("b",{children:"Last Update:"}),e.jsx("span",{className:"inline-block ml-1",children:le(new Date(n),"yyyy-mm-dd hh-mm-ss",!1)})]})]})}function Me({className:s,modelName:n,changeType:a}){return e.jsx("span",{className:g("font-bold whitespace-nowrap",a===P.Add&&"text-success-600  dark:text-success-500",a===P.Remove&&"text-danger-500",a===P.Direct&&"text-secondary-500 dark:text-primary-500",a===P.Indirect&&"text-warning-500",a===P.Default&&"text-prose",s),children:n})}h.Block=Ce;h.Summary=Rs;h.Details=Es;h.DetailsProgress=he;h.Task=ue;h.Tasks=we;h.TaskDetails=xe;h.TaskProgress=fe;h.TaskSize=ie;h.TaskDivider=re;h.TaskInfo=pe;h.TaskHeadline=Ve;function Be({modelName:s,changesAdded:n,changesRemoved:a,changesModifiedDirect:l,changesModifiedIndirect:d}){return n.includes(s)?P.Add:a.includes(s)?P.Remove:l.includes(s)?P.Direct:d.includes(s)?P.Indirect:P.Default}function As({report:s}){var n;return e.jsxs("div",{children:[e.jsxs("div",{className:"py-2",children:[e.jsxs("p",{children:["Total: ",s.total]}),e.jsxs("p",{children:["Succeeded: ",s.successful]}),e.jsxs("p",{children:["Failed: ",s.failures]}),e.jsxs("p",{children:["Errors: ",s.errors]}),e.jsxs("p",{children:["Dialect: ",s.dialect]})]}),e.jsx("ul",{children:(n=s.details)==null?void 0:n.map(a=>e.jsxs("li",{className:"flex mb-1",children:[e.jsx("span",{className:"inline-block mr-4",children:"—"}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsx("span",{className:"inline-block mb-2",children:a.message}),e.jsx("code",{className:"inline-block max-h-[50vh] bg-theme py-2 px-4 rounded-lg w-full overflow-auto hover:scrollbar scrollbar--vertical scrollbar--horizontal",children:e.jsx("pre",{children:a.details})})]})]},a.message))})]})}function Ms(){var v,f,F,S,T,O,z,U,k,E,V,b,ce;const{testsReportMessages:s,testsReportErrors:n}=G(),a=X(se=>se.planApply),l=X(se=>se.planOverview),d=a.start??l.start,m=a.end??l.end,c=((v=a.overview)==null?void 0:v.hasChanges)??l.hasChanges,t=((f=a.overview)==null?void 0:f.hasBackfills)??l.hasBackfills,u=a.changes??l.changes,o=a.backfills??l.backfills,x=a.validation??l.validation,i=a.plan_options??l.plan_options,r=((F=a.overview)==null?void 0:F.isVirtualUpdate)??l.isVirtualUpdate,w=N(a.creation)||N(a.backfill)||N(a.promote),C=((T=(S=a.creation)==null?void 0:S.meta)==null?void 0:T.start)??((z=(O=a.backfill)==null?void 0:O.meta)==null?void 0:z.start)??((k=(U=a.promote)==null?void 0:U.meta)==null?void 0:k.start);return e.jsxs("div",{className:"py-4",children:[N(d)&&N(m)&&e.jsxs("div",{className:"flex justify-between items-center mb-4 whitespace-nowrap",children:[e.jsxs("small",{className:"text-neutral-500 block px-4",children:["Start Date: ",e.jsx("b",{children:le(new Date(d))})]}),e.jsx(W,{}),e.jsxs("small",{className:"text-neutral-500 block px-4",children:["End Date: ",e.jsx("b",{children:le(new Date(m))})]})]}),_e(c)||I(u)?e.jsx(de,{variant:y.Info,className:"mt-2",children:"No Changes"}):e.jsx(Bs,{report:u}),_e(t)||I(o)?e.jsx(de,{variant:y.Info,className:"mt-2",children:"No Backfills"}):e.jsx(Is,{report:o}),Z(i==null?void 0:i.skip_tests)&&e.jsx(de,{variant:y.Info,className:"mt-2",children:"Tests Skipped"}),N(s)&&e.jsx(Os,{report:s}),N(n)&&e.jsx(zs,{report:n}),N(x)&&e.jsx(Us,{report:x}),Z(r)&&e.jsx(Ws,{isUpdated:Z((V=(E=a.promote)==null?void 0:E.meta)==null?void 0:V.done)}),I(n)&&w&&e.jsxs(Vs,{start:C,end:(ce=(b=a.promote)==null?void 0:b.meta)==null?void 0:ce.end,children:[N(a.creation)&&e.jsx($s,{report:a.creation}),N(a.restate)?e.jsx(Gs,{report:a.restate}):e.jsx(de,{variant:y.Info,className:"mt-2",children:"No Models To Restate"}),N(a.backfill)&&N(a.environment)&&e.jsx(Ls,{backfill:a.backfill,backfills:o,isVirtualUpdate:r,environment:a.environment}),N(a.promote)&&e.jsx(Hs,{report:a.promote})]})]})}function Bs({report:s}){return e.jsx(L,{meta:s.meta,states:["Changes Collected","Failed Getting Plan Changes","Getting Plan Changes..."],isOpen:!0,panel:e.jsx(Ks,{})})}function Is({report:s}){var n,a;return e.jsx(L,{meta:s.meta,states:["Backfills Collected","Failed Getting Plan Backfills","Getting Plan Backfills..."],isOpen:!0,panel:e.jsx(A,{headline:`Models ${((n=s.models)==null?void 0:n.length)??0}`,type:P.Default,children:e.jsx(A.Default,{type:P.Default,changes:((a=s==null?void 0:s.models)==null?void 0:a.map(({model_name:l})=>l))??[]})})})}function Os({report:s}){return e.jsx(L,{meta:{status:"success",...s},trigger:e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"w-6 mr-4"}),e.jsx(ee,{text:"Tests Completed",size:D.sm,variant:y.Success,className:"w-full"})]}),children:e.jsx("p",{className:"mb-0.5",children:s.message})})}function zs({report:s}){return e.jsx(L,{variant:y.Danger,meta:{status:"fail",...s},trigger:e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"w-6 mr-4"}),e.jsx(ee,{text:"Tests Failed",size:D.sm,variant:y.Danger,className:"w-full"})]}),children:e.jsx(As,{report:s})})}function Us({report:s}){return e.jsx(L,{meta:s.meta,states:["Plan Validated","Plan Validation Failed","Validating Plan..."],showDetails:!1})}function Vs({start:s,end:n,children:a}){return e.jsxs("div",{className:"pt-6 pb-2",children:[N(s)&&e.jsxs(e.Fragment,{children:[e.jsxs("small",{className:"text-neutral-500 block px-4 mb-1",children:["Evaluation started at"," ",e.jsx("b",{children:le(new Date(s),"yyyy-mm-dd hh-mm-ss")})]}),e.jsx(W,{}),e.jsx("small",{className:"text-neutral-500 block px-4 mt-1",children:"Given a plan, it pushes snapshots into the state and then kicks off the backfill process for all affected snapshots. Once backfill is done, snapshots that are part of the plan are promoted in the environment targeted by this plan."})]}),e.jsx("div",{className:"py-2",children:a}),N(n)&&e.jsxs(e.Fragment,{children:[e.jsx(W,{}),e.jsxs("small",{className:"text-neutral-500 block px-4 mt-1",children:["Evaluation stopped at"," ",e.jsx("b",{children:le(new Date(n),"yyyy-mm-dd hh-mm-ss")})]})]})]})}function $s({report:s,isOpen:n}){return e.jsx(L,{meta:s.meta,states:["Snapshot Tables Created","Snapshot Tables Creation Failed","Creating Snapshot Tables..."],isOpen:n,children:N(s.total_tasks)&&e.jsx(h.Block,{children:e.jsxs(h.Task,{children:[e.jsxs(h.TaskDetails,{children:[e.jsx(h.TaskInfo,{children:e.jsx(h.TaskHeadline,{headline:"Snapshot Tables"})}),e.jsxs(h.DetailsProgress,{children:[e.jsx(h.TaskSize,{completed:s.total_tasks,total:s.num_tasks,unit:"task"}),e.jsx(h.TaskDivider,{}),e.jsx(h.TaskProgress,{completed:s.num_tasks,total:s.total_tasks})]})]}),e.jsx(te,{progress:q(s.num_tasks,s.total_tasks)})]})})})}function Gs({report:s}){return e.jsx(L,{meta:s.meta,states:["Restate Models","Restate Models Failed","Restating Models..."]})}function Ls({environment:s,backfill:n,isVirtualUpdate:a,backfills:l}){const{change_categorization:d}=G(),m=j.useMemo(()=>Array.from(d.values()).reduce((t,{category:u,change:o})=>{var x;return(x=o==null?void 0:o.indirect)==null||x.forEach(i=>{var r;I(t[i])&&(t[i]=[]),(r=t[i])==null||r.push(u.value!==Re.NUMBER_1)}),u.value===Re.NUMBER_3&&(t[o.model_name]=[!0]),t},{}),[d]),c=j.useMemo(()=>{var t;return((t=l==null?void 0:l.models)==null?void 0:t.reduce((u,o)=>{var v;const x=o.view_name,i=o.interval,r={completed:0,total:o.batches,interval:i,view_name:o.view_name,...(v=n==null?void 0:n.tasks)==null?void 0:v[x]},w=m[x];return(I(w)?!1:w.every(Boolean))||(u[x]=r),u},{}))??{}},[n,l,d]);return e.jsx(L,{meta:n.meta,states:["Intervals Backfilled","Intervals Backfilling Failed","Backfilling Intervals..."],showDetails:!0,isOpen:!0,children:e.jsx(h,{tasks:c,children:({total:t,completed:u,models:o,completedBatches:x,totalBatches:i})=>e.jsxs(e.Fragment,{children:[e.jsx(h.Summary,{environment:s,headline:"Target Environment",completed:u,total:t,completedBatches:x,totalBatches:i,updateType:a?"Virtual":"Backfill"}),N(o)&&e.jsx(h.Details,{models:o,queue:n.queue,showBatches:!0,showVirtualUpdate:a,showProgress:!0})]})})})}function Hs({report:s}){return e.jsx(L,{meta:s.meta,states:["Environment Promoted","Promotion Failed","Promoting Environment..."],children:e.jsx(h.Block,{children:e.jsxs(h.Task,{children:[e.jsxs(h.TaskDetails,{children:[e.jsx(h.TaskInfo,{children:e.jsx(h.TaskHeadline,{headline:`Promote Environment: ${s.target_environment}`})}),e.jsxs(h.DetailsProgress,{children:[e.jsx(h.TaskSize,{completed:s.total_tasks,total:s.num_tasks,unit:"task"}),e.jsx(h.TaskDivider,{}),e.jsx(h.TaskProgress,{completed:s.num_tasks,total:s.total_tasks})]})]}),e.jsx(te,{progress:q(s.num_tasks,s.total_tasks)})]})})})}function Ks(){var x,i,r;const s=X(w=>w.planOverview),n=X(w=>w.planApply),a=((x=n.overview)==null?void 0:x.isRunning)??s.isRunning,l=((i=n.overview)==null?void 0:i.hasChanges)??s.hasChanges,d=n.changes??s.changes,m=((r=n.overview)==null?void 0:r.isVirtualUpdate)??s.isVirtualUpdate,c=R(l)&&R(a)&&R(m)||a,{added:t=[],removed:u=[],modified:o={}}=d??{};return e.jsxs("div",{className:g("w-full my-2",c&&"h-[25vh]"),children:[a&&e.jsx(K,{isFull:!0,isCenter:!0,children:e.jsx(Ne,{text:"Checking Models...",hasSpinner:!0,size:D.lg})}),R(l)&&R(a)&&e.jsx(K,{isFull:R(m),isCenter:R(m),children:e.jsx(ee,{size:m?D.md:D.lg,text:"No Changes"})}),Z(l)&&R(a)&&e.jsxs(e.Fragment,{children:[($(t)||$(u))&&e.jsxs("div",{className:"flex",children:[$(t)&&e.jsx(A,{className:"w-full my-2",headline:"Added Models",type:P.Add,children:e.jsx(A.Default,{type:P.Add,changes:t})}),$(u)&&e.jsx(A,{className:"w-full my-2",headline:"Removed Models",type:P.Remove,children:e.jsx(A.Default,{type:P.Remove,changes:u})})]}),ks(o)&&e.jsxs(e.Fragment,{children:[$(o==null?void 0:o.direct)&&e.jsx(A,{className:"my-2 w-full",headline:"Modified Directly",type:P.Direct,children:e.jsx(A.Direct,{changes:o.direct??[]})}),$(o.indirect)&&e.jsx(A,{className:"my-2 w-full",headline:"Modified Indirectly",type:P.Indirect,children:e.jsx(A.Indirect,{changes:o.indirect??[]})}),$(o==null?void 0:o.metadata)&&e.jsx(A,{className:"my-2 w-full",headline:"Modified Metadata",type:P.Default,children:e.jsx(A.Default,{type:P.Default,changes:(o==null?void 0:o.metadata)??[]})})]})]})]})}function Ws({isUpdated:s=!1}){const{virtualUpdateDescription:n}=G();return e.jsx(M,{children:({open:a})=>e.jsxs(e.Fragment,{children:[e.jsxs(K,{className:"my-2 flex items-center",variant:s?y.Success:y.Info,children:[e.jsxs(e.Fragment,{children:[s&&e.jsx(ve,{className:"w-6 mr-4"}),e.jsx(ee,{className:"w-full",text:s?"Virtual Update Completed":"Virtual Update",size:D.sm,variant:s?y.Success:y.Info})]}),e.jsx("div",{className:"flex items-center",children:e.jsx(M.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:a?e.jsx(je,{className:"w-5"}):e.jsx(ge,{className:"w-5"})})})]}),e.jsx(M.Panel,{className:"px-2 text-xs",children:e.jsx("div",{className:"p-4 rounded-md bg-neutral-5",children:n})})]})})}function de({hasSpinner:s=!1,variant:n=y.Primary,index:a,children:l,className:d}){return e.jsx(K,{className:d,variant:n,children:e.jsxs("span",{className:"flex items-center w-full",children:[N(a)&&e.jsxs("span",{className:"inline-block mr-3 font-black whitespace-nowrap",children:["Stage ",a,":"]}),s&&e.jsx(ze,{className:"w-4 h-4 mr-2"}),l]})})}function L({meta:s,states:n=["Success","Failed","Running"],isOpen:a=!1,trigger:l,panel:d,children:m,showDetails:c=!0}){const t=s.status==="success"?y.Success:s.status==="fail"?y.Danger:y.Info,[u,o,x]=n,i=s.status==="success"?u:s.status==="fail"?o:x;return e.jsx(M,{defaultOpen:a,children:({open:r})=>e.jsxs(e.Fragment,{children:[e.jsxs(K,{className:"my-2 flex items-center",variant:t,children:[I(l)?e.jsxs(e.Fragment,{children:[s.status==="success"&&e.jsx(ve,{className:"w-6 mr-4"}),s.status==="fail"&&e.jsx(ps,{className:"w-6 mr-4"}),s.status==="init"?e.jsx(Ne,{text:i,hasSpinner:!0,size:D.sm,variant:y.Primary,className:"w-full"}):e.jsxs("span",{className:"flex w-full items-baseline",children:[e.jsx(ee,{text:i,size:D.sm,variant:t}),N(s.duration)&&e.jsxs("p",{className:"text-xs text-neutral-400 inline-block ml-2",children:["in ",e.jsx("b",{children:s.duration/1e3})," seconds"]})]})]}):l,c&&e.jsx("div",{className:"flex items-center",children:e.jsx(M.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:r?e.jsx(je,{className:"w-5"}):e.jsx(ge,{className:"w-5"})})})]}),e.jsxs(M.Panel,{className:g("px-2 text-xs"),children:[N(m)&&e.jsx("div",{className:g("p-4 rounded-md",t===y.Danger?"bg-danger-10 text-danger-500":"bg-neutral-5"),children:m}),s.status!=="fail"&&d]})]})})}function Qs({disabled:s,onClose:n}){const a=ke(),{removeError:l}=Ue(),{auto_apply:d}=G(),m=J(b=>b.isRunningPlan),c=J(b=>b.environment),t=X(b=>b.planOverview),u=X(b=>b.planApply),o=X(b=>b.planCancel),x=I(c==null?void 0:c.isDefault)||Z(c==null?void 0:c.isDefault),i=Ss({environment:c,isInitialPlanRun:x}),r=_s({isInitialPlanRun:x}),{refetch:w,cancel:C}=ss(c.name,i),{refetch:v,cancel:f}=as(c.name,r),{refetch:F}=ns(),[S,T]=j.useState(p.Run);j.useEffect(()=>{t.isFinished&&(u.isFinished||R(t.isVirtualUpdate)&&R(t.isBackfillUpdate))?T(p.Done):m&&u.isRunning?T(p.Applying):m&&t.isRunning?T(p.Running):t.isFinished&&t.isVirtualUpdate?T(p.ApplyVirtual):t.isFinished&&t.isBackfillUpdate?T(p.ApplyBackfill):o.isCancelling?T(p.Cancelling):T(p.Run)},[t,u,m]);function O(){a([{type:_.ResetPlanOptions}])}function z(){t.reset(),u.reset(),O(),T(p.Run)}function U(){l(Ee.RunPlan),l(Ee.ApplyPlan),O(),n()}function k(){a([{type:_.ResetTestsReport}]),T(p.Cancelling);let b;S===p.Applying?b=C:b=f,b(),F().then(()=>{T(p.Run)}).catch(()=>{z()})}function E(){a([{type:_.ResetTestsReport}]),v().catch(console.log)}function V(){u.reset(),a([{type:_.ResetTestsReport}]),w().then(({data:b})=>{a([{type:_.Dates,start:b==null?void 0:b.start,end:b==null?void 0:b.end}]),d&&E()})}return e.jsxs("div",{className:"flex flex-col w-full h-full overflow-hidden pt-6",children:[e.jsx(ws,{}),e.jsx(W,{}),e.jsx("div",{className:"w-full h-full px-4 overflow-y-scroll hover:scrollbar scrollbar--vertical",children:S===p.Cancelling?e.jsx(Xs,{}):u.isRunning||t.isFinished?e.jsx(Ms,{}):e.jsx(Ds,{className:"w-full"})}),e.jsx(W,{}),e.jsx(Ps,{planAction:S,disabled:s,apply:E,run:V,cancel:k,close:U,reset:z})]})}function Xs(){return e.jsx("div",{className:"w-full h-full p-4",children:e.jsx("div",{className:"w-full h-full flex justify-center items-center p-4 bg-warning-10 rounded-lg overflow-hidden",children:e.jsxs(Ne,{className:"inline-block",children:[e.jsx(ze,{variant:y.Warning,className:"w-3 h-3 border border-neutral-10 mr-4"}),e.jsx("h3",{className:"text-2xl text-warning-500 font-bold",children:"Cancelling Plan..."})]})})})}const ra=j.memo(function(){const{isPlanOpen:n,setIsPlanOpen:a}=Ue(),[l,d]=j.useState(!1);function m(){d(!0)}const c=Z(n)&&R(l);return e.jsx(ys,{show:c,afterLeave:()=>{d(!1),a(!1)},children:e.jsx(Oe.Panel,{className:"bg-theme border-8 border-r-0 border-secondary-10 dark:border-primary-10 absolute w-[90%] md:w-[75%] xl:w-[60%] h-full right-0 flex flex-col",children:e.jsx(cs,{children:e.jsx(Qs,{disabled:l,onClose:m})})})})});export{ra as default};
