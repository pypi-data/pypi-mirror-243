image:
  name: python:3.8-slim-bullseye
  entrypoint: [ '/bin/bash', '-c', 'ln -snf /bin/bash /bin/sh && /bin/bash -c $0' ]

stages:
  - build
  - deploy

default:
  before_script:
    - apt-get update && apt-get install -y git
    - pip install --upgrade pip setuptools setuptools-scm wheel build twine sphinx-rtd-theme==1.3.0rc1

package:
  stage: build
  script:
    - python -m build
  artifacts:
    paths:
      - dist/

docs:
  stage: build
  script:
    - pip install -r docs/requirements.txt
    - pip install .
    - sphinx-build -b html docs/ build/docs/
  artifacts:
    paths:
      - build/

upload:
  stage: deploy
  dependencies:
    - package
  rules:
    - if: '$CI_COMMIT_TAG =~ /^([0-9]+)\.([0-9]+)\.([0-9]+)$/ && $PYPI_USERNAME && $PYPI_PASSWORD'
  script:
    - python -m twine upload -u $PYPI_USERNAME -p $PYPI_PASSWORD dist/*

pages:
  stage: deploy
  dependencies:
    - docs
  rules:
    - if: '$CI_COMMIT_TAG =~ /^([0-9]+)\.([0-9]+)\.([0-9]+)$/'
  script:
    - mv build/docs/ public/
  artifacts:
    paths:
    - public

